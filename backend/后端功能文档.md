# 简易在线商城后端功能文档

## 项目概述

后端采用 Node.js + Express 框架开发，使用 PostgreSQL 作为数据库，实现了完整的 RESTful API 接口。

## 技术栈

- **运行环境**: Node.js
- **框架**: Express
- **数据库**: PostgreSQL
- **认证**: JWT
- **密码加密**: BCrypt
- **文件上传**: Multer
- **安全**: Helmet, CORS

## 目录结构

```
backend/
├── src/
│   ├── config/        # 配置文件
│   ├── controllers/   # 控制器
│   ├── middleware/    # 中间件
│   ├── models/        # 数据模型（当前使用直接数据库查询）
│   ├── routes/        # 路由定义
│   ├── services/      # 业务逻辑（当前使用直接数据库查询）
│   └── utils/         # 工具函数
├── uploads/           # 文件上传目录
├── __tests__/         # 测试文件
└── package.json
```

## API 接口文档

### 1. 用户管理接口 (User Management)

#### 1.1 用户注册
- **接口**: `POST /api/users/register`
- **功能**: 新用户注册
- **请求参数**:
  ```json
  {
    "username": "string (必填)",
    "email": "string (必填)",
    "password": "string (必填)",
    "role": "string (选填, 默认 'buyer')"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "用户注册成功",
    "user": {
      "id": "integer",
      "username": "string",
      "email": "string",
      "role": "string",
      "created_at": "datetime"
    }
  }
  ```
- **权限**: 公开
- **说明**: 密码会自动加密存储，用户名和邮箱唯一性验证

#### 1.2 用户登录
- **接口**: `POST /api/users/login`
- **功能**: 用户登录
- **请求参数**:
  ```json
  {
    "username": "string (必填)",
    "password": "string (必填)"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "登录成功",
    "token": "JWT token",
    "user": {
      "id": "integer",
      "username": "string",
      "email": "string",
      "role": "string"
    }
  }
  ```
- **权限**: 公开
- **说明**: 登录成功返回JWT token用于后续认证

#### 1.3 获取用户资料
- **接口**: `GET /api/users/profile`
- **功能**: 获取当前登录用户资料
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "user": {
      "id": "integer",
      "username": "string",
      "email": "string",
      "role": "string",
      "created_at": "datetime"
    }
  }
  ```
- **权限**: 需要认证

#### 1.4 获取所有用户（管理员）
- **接口**: `GET /api/users`
- **功能**: 获取所有用户列表（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **查询参数**:
  - `page`: 页码，默认1
  - `limit`: 每页数量，默认10
- **响应参数**:
  ```json
  {
    "users": [
      {
        "id": "integer",
        "username": "string",
        "email": "string",
        "role": "string",
        "created_at": "datetime"
      }
    ]
  }
  ```
- **权限**: 仅管理员

#### 1.5 删除用户（管理员）
- **接口**: `DELETE /api/users/:id`
- **功能**: 删除指定用户（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 用户ID
- **响应参数**:
  ```json
  {
    "message": "用户删除成功"
  }
  ```
- **权限**: 仅管理员
- **说明**: 删除用户时会级联删除相关数据

### 2. 商品管理接口 (Product Management)

#### 2.1 获取商品列表
- **接口**: `GET /api/products`
- **功能**: 获取商品列表
- **查询参数**:
  - `page`: 页码，默认1
  - `limit`: 每页数量，默认10
  - `status`: 商品状态（仅管理员可查看非active状态）
- **响应参数**:
  ```json
  {
    "products": [
      {
        "id": "integer",
        "name": "string",
        "description": "string",
        "price": "decimal",
        "stock_quantity": "integer",
        "image_url": "string",
        "seller_id": "integer",
        "status": "string",
        "created_at": "datetime",
        "updated_at": "datetime",
        "seller_name": "string"
      }
    ],
    "pagination": {
      "current_page": "integer",
      "total_pages": "integer",
      "total_items": "integer",
      "items_per_page": "integer"
    }
  }
  ```
- **权限**: 公开（买家和管理员），商家有特殊权限

#### 2.2 获取商品详情
- **接口**: `GET /api/products/:id`
- **功能**: 获取指定商品详情
- **路径参数**: `id` - 商品ID
- **响应参数**:
  ```json
  {
    "product": {
      "id": "integer",
      "name": "string",
      "description": "string",
      "price": "decimal",
      "stock_quantity": "integer",
      "image_url": "string",
      "seller_id": "integer",
      "status": "string",
      "created_at": "datetime",
      "updated_at": "datetime",
      "seller_name": "string"
    }
  }
  ```
- **权限**: 公开（仅active状态商品）

#### 2.3 搜索商品
- **接口**: `GET /api/products/search`
- **功能**: 搜索商品
- **查询参数**:
  - `q`: 搜索关键词（必填）
  - `page`: 页码，默认1
  - `limit`: 每页数量，默认10
- **响应参数**: 同商品列表

#### 2.4 创建商品（商家）
- **接口**: `POST /api/products`
- **功能**: 创建新商品（仅商家）
- **请求头**: `Authorization: Bearer <token>`
- **请求参数**:
  ```json
  {
    "name": "string (必填)",
    "description": "string",
    "price": "decimal (必填)",
    "stock_quantity": "integer (必填)",
    "image_url": "string"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "商品创建成功",
    "product": {
      "id": "integer",
      "name": "string",
      "description": "string",
      "price": "decimal",
      "stock_quantity": "integer",
      "image_url": "string",
      "seller_id": "integer",
      "status": "string (默认 'inactive')",
      "created_at": "datetime",
      "updated_at": "datetime"
    }
  }
  ```
- **权限**: 仅商家
- **说明**: 新商品默认为inactive状态（待审核）

#### 2.5 更新商品（商家/管理员）
- **接口**: `PUT /api/products/:id`
- **功能**: 更新商品信息
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 商品ID
- **请求参数**:
  ```json
  {
    "name": "string",
    "description": "string",
    "price": "decimal",
    "stock_quantity": "integer",
    "image_url": "string",
    "status": "string (仅管理员可修改)"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "商品更新成功",
    "product": { ... }
  }
  ```
- **权限**: 商家（自己的商品）或管理员

#### 2.6 获取商家商品列表
- **接口**: `GET /api/products/seller`
- **功能**: 获取当前商家的商品列表
- **请求头**: `Authorization: Bearer <token>`
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量
  - `status`: 商品状态过滤
- **响应参数**: 同商品列表

#### 2.7 批准商品上架（管理员）
- **接口**: `POST /api/products/:id/approve`
- **功能**: 管理员批准商品上架
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 商品ID
- **响应参数**:
  ```json
  {
    "message": "商品已批准上架",
    "product": { ... }
  }
  ```
- **权限**: 仅管理员

#### 2.8 下架商品（管理员）
- **接口**: `POST /api/products/:id/suspend`
- **功能**: 管理员下架违规商品
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 商品ID
- **响应参数**:
  ```json
  {
    "message": "商品已因违规下架",
    "product": { ... }
  }
  ```
- **权限**: 仅管理员

#### 2.9 恢复商品（管理员）
- **接口**: `POST /api/products/:id/restore`
- **功能**: 管理员恢复误下架商品
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 商品ID
- **响应参数**:
  ```json
  {
    "message": "商品已恢复",
    "product": { ... }
  }
  ```
- **权限**: 仅管理员

#### 2.10 获取热门商品
- **接口**: `GET /api/products/popular`
- **功能**: 获取热门商品（基于销量）
- **查询参数**: `limit` - 数量，默认4
- **响应参数**:
  ```json
  {
    "products": [
      {
        "id": "integer",
        "name": "string",
        "description": "string",
        "price": "decimal",
        "stock_quantity": "integer",
        "image_url": "string",
        "seller_id": "integer",
        "status": "string",
        "created_at": "datetime",
        "updated_at": "datetime",
        "seller_name": "string",
        "total_sold": "integer"
      }
    ]
  }
  ```

### 3. 购物车接口 (Cart Management)

#### 3.1 获取购物车
- **接口**: `GET /api/cart`
- **功能**: 获取当前用户的购物车
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "cart": {
      "items": [
        {
          "cart_id": "integer",
          "quantity": "integer",
          "product_id": "integer",
          "name": "string",
          "price": "decimal",
          "stock_quantity": "integer",
          "image_url": "string",
          "description": "string",
          "created_at": "datetime",
          "updated_at": "datetime"
        }
      ],
      "total_amount": "decimal",
      "item_count": "integer"
    }
  }
  ```
- **权限**: 需要认证

#### 3.2 添加到购物车
- **接口**: `POST /api/cart`
- **功能**: 添加商品到购物车
- **请求头**: `Authorization: Bearer <token>`
- **请求参数**:
  ```json
  {
    "productId": "integer (必填)",
    "quantity": "integer (选填, 默认1)"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "成功添加到购物车",
    "cart_item": { ... }
  }
  ```
- **权限**: 需要认证
- **说明**: 检查库存和商品状态

#### 3.3 更新购物车项目
- **接口**: `PUT /api/cart/:productId`
- **功能**: 更新购物车中商品数量
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `productId` - 商品ID
- **请求参数**:
  ```json
  {
    "quantity": "integer (必填)"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "购物车项目更新成功",
    "cart_item": { ... }
  }
  ```
- **权限**: 需要认证

#### 3.4 从购物车移除项目
- **接口**: `DELETE /api/cart/:productId`
- **功能**: 从购物车移除商品
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `productId` - 商品ID
- **响应参数**:
  ```json
  {
    "message": "成功从购物车移除商品"
  }
  ```
- **权限**: 需要认证

### 4. 订单接口 (Order Management)

#### 4.1 创建订单
- **接口**: `POST /api/orders`
- **功能**: 从购物车创建订单
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "message": "订单创建成功",
    "order": {
      "id": "integer",
      "total_amount": "decimal",
      "status": "string",
      "created_at": "datetime",
      "items": [
        {
          "product_id": "integer",
          "quantity": "integer",
          "price": "decimal",
          "product_name": "string"
        }
      ]
    }
  }
  ```
- **权限**: 需要认证
- **说明**: 使用数据库事务确保数据一致性

#### 4.2 获取用户订单
- **接口**: `GET /api/orders`
- **功能**: 获取当前用户的订单列表
- **请求头**: `Authorization: Bearer <token>`
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量
- **响应参数**:
  ```json
  {
    "orders": [
      {
        "id": "integer",
        "total_amount": "decimal",
        "status": "string",
        "created_at": "datetime",
        "items": [ ... ]
      }
    ],
    "pagination": { ... }
  }
  ```
- **权限**: 需要认证

#### 4.3 获取订单详情
- **接口**: `GET /api/orders/:id`
- **功能**: 获取订单详情
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 订单ID
- **响应参数**:
  ```json
  {
    "order": {
      "id": "integer",
      "total_amount": "decimal",
      "status": "string",
      "created_at": "datetime",
      "updated_at": "datetime",
      "items": [
        {
          "product_id": "integer",
          "quantity": "integer",
          "price": "decimal",
          "product_name": "string",
          "product_description": "string"
        }
      ]
    }
  }
  ```
- **权限**: 需要认证（仅订单所有者）

#### 4.4 支付订单
- **接口**: `POST /api/orders/:id/pay`
- **功能**: 支付订单
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 订单ID
- **响应参数**:
  ```json
  {
    "message": "订单支付成功",
    "order": { ... }
  }
  ```
- **权限**: 需要认证（仅订单所有者）

#### 4.5 获取所有订单（管理员）
- **接口**: `GET /api/orders/admin`
- **功能**: 获取所有订单（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量
- **响应参数**:
  ```json
  {
    "orders": [
      {
        "id": "integer",
        "user_id": "integer",
        "total_amount": "decimal",
        "status": "string",
        "created_at": "datetime",
        "updated_at": "datetime",
        "username": "string",
        "items": [ ... ]
      }
    ],
    "pagination": { ... }
  }
  ```
- **权限**: 仅管理员

#### 4.6 更新订单状态（管理员）
- **接口**: `PUT /api/orders/:id/status`
- **功能**: 更新订单状态（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **路径参数**: `id` - 订单ID
- **请求参数**:
  ```json
  {
    "status": "string (pending|paid|shipped|delivered|cancelled)"
  }
  ```
- **响应参数**:
  ```json
  {
    "message": "订单状态更新成功",
    "order": { ... }
  }
  ```
- **权限**: 仅管理员

#### 4.7 获取商家订单
- **接口**: `GET /api/orders/seller`
- **功能**: 获取与商家商品相关的订单
- **请求头**: `Authorization: Bearer <token>`
- **查询参数**:
  - `page`: 页码
  - `limit`: 每页数量
- **响应参数**:
  ```json
  {
    "orders": [ ... ],
    "pagination": { ... }
  }
  ```
- **权限**: 仅商家

### 5. 管理员接口 (Admin Management)

#### 5.1 获取系统统计信息
- **接口**: `GET /api/admin/stats`
- **功能**: 获取系统统计信息（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "stats": {
      "total_orders": "integer",
      "total_users": "integer",
      "total_products": "integer",
      "today_revenue": "decimal"
    },
    "user_role_stats": [
      {
        "role": "string",
        "count": "integer"
      }
    ],
    "product_status_stats": [
      {
        "status": "string",
        "count": "integer"
      }
    ],
    "recent_orders": [
      {
        "id": "integer",
        "total_amount": "decimal",
        "status": "string",
        "created_at": "datetime"
      }
    ]
  }
  ```
- **权限**: 仅管理员

#### 5.2 获取商家收入统计
- **接口**: `GET /api/admin/revenue-stats`
- **功能**: 获取所有商家收入统计（仅管理员）
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "revenue_stats": [
      {
        "seller_id": "integer",
        "seller_name": "string",
        "total_orders": "integer",
        "total_revenue": "decimal"
      }
    ]
  }
  ```
- **权限**: 仅管理员

### 6. 商家接口 (Seller Management)

#### 6.1 获取商家统计信息
- **接口**: `GET /api/seller/stats`
- **功能**: 获取当前商家统计信息
- **请求头**: `Authorization: Bearer <token>`
- **响应参数**:
  ```json
  {
    "stats": {
      "total_products": "integer",
      "active_products": "integer",
      "total_orders": "integer",
      "total_revenue": "decimal",
      "average_order_value": "decimal"
    }
  }
  ```
- **权限**: 仅商家

## 数据库设计

### 用户表 (users)
- id: 主键
- username: 用户名（唯一）
- email: 邮箱（唯一）
- password_hash: 密码哈希
- role: 角色（buyer/seller/admin）
- created_at: 创建时间

### 商品表 (products)
- id: 主键
- name: 商品名称
- description: 商品描述
- price: 价格
- stock_quantity: 库存数量
- image_url: 图片URL
- seller_id: 商家ID（外键）
- status: 状态（active/inactive/suspended）
- created_at: 创建时间
- updated_at: 更新时间

### 购物车表 (cart)
- id: 主键
- user_id: 用户ID（外键）
- product_id: 商品ID（外键）
- quantity: 数量
- created_at: 创建时间
- updated_at: 更新时间

### 订单表 (orders)
- id: 主键
- user_id: 用户ID（外键）
- total_amount: 订单总金额
- status: 订单状态
- created_at: 创建时间
- updated_at: 更新时间

### 订单项表 (order_items)
- id: 主键
- order_id: 订单ID（外键）
- product_id: 商品ID（外键）
- quantity: 数量
- price_at_time: 下单时价格

## 安全特性

1. **JWT认证**: 所有受保护的接口都需要有效的JWT token
2. **密码加密**: 使用BCrypt对用户密码进行加密存储
3. **权限控制**: 不同角色有不同的访问权限
4. **SQL注入防护**: 使用参数化查询防止SQL注入
5. **输入验证**: 对所有输入参数进行验证
6. **CORS**: 配置跨域资源共享策略

## 错误处理

- 400 Bad Request: 请求参数错误
- 401 Unauthorized: 未认证或认证失败
- 403 Forbidden: 权限不足
- 404 Not Found: 资源不存在
- 500 Internal Server Error: 服务器内部错误

## 中间件

- **身份验证中间件**: 验证JWT token并解析用户信息
- **CORS中间件**: 处理跨域请求
- **安全中间件**: 使用Helmet增强安全性