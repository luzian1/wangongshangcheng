# 皖工购物网后端测试文档

## 1. 概述

本文档详细介绍了皖工购物网后端项目的测试策略、测试类型、测试用例和测试执行流程。项目采用多层次的测试策略，包括单元测试、集成测试和系统测试，以确保代码质量和系统稳定性。

## 2. 测试策略

### 2.1 测试层次

项目采用三层测试策略：

- **单元测试**：测试单个函数、方法或类的功能
- **集成测试**：测试多个组件之间的交互
- **系统测试**：测试整个系统的端到端功能

### 2.2 测试工具

- **Jest**：JavaScript测试框架，用于单元测试和集成测试
- **Supertest**：用于测试HTTP请求的库，用于集成测试和系统测试
- **Node.js**：运行时环境

## 3. 单元测试

### 3.1 测试范围

单元测试主要覆盖以下模块：

- 控制器（Controllers）
- 数据库配置（Database Configuration）
- 中间件（Middleware）
- 服务层（Services，如果存在）

### 3.2 测试示例

#### 3.2.1 用户控制器单元测试

用户控制器的单元测试包括以下测试用例：

- **用户注册**
  - 正常注册流程
  - 用户名或邮箱已存在的情况
  - 注册错误处理

- **用户登录**
  - 正常登录流程
  - 用户名或密码错误
  - 用户不存在的情况

- **获取用户资料**
  - 正常获取用户资料
  - 用户不存在的情况

- **管理员功能**
  - 获取所有用户（管理员权限）
  - 删除用户（管理员权限）

#### 3.2.2 数据库配置单元测试

- 数据库连接功能
- 查询方法
- 错误处理

#### 3.2.3 认证中间件单元测试

- 令牌验证
- 无效令牌处理
- 缺少令牌处理
- 角色检查

### 3.3 单元测试执行

运行单元测试：

```bash
npm test
# 或者
npm run test:watch  # 监听模式
npm run test:coverage  # 生成覆盖率报告
```

## 4. 集成测试

### 4.1 测试范围

集成测试主要测试以下API端点的集成：

- 用户路由（/api/users）
- 产品路由（/api/products）
- 购物车路由（/api/cart）
- 订单路由（/api/orders）
- 管理员路由（/api/admin）

### 4.2 测试示例

#### 4.2.1 用户路由集成测试

- **注册功能**
  - 成功注册新用户
  - 用户已存在的情况
  - 缺少必要字段的情况

- **登录功能**
  - 成功登录
  - 无效凭据
  - 用户不存在

- **获取资料功能**
  - 使用有效令牌获取资料
  - 使用无效令牌
  - 缺少令牌

- **管理员功能**
  - 管理员获取所有用户
  - 普通用户访问受限功能

#### 4.2.2 产品路由集成测试

- **获取产品列表**
  - 获取所有活跃产品
  - 空产品列表

- **获取单个产品**
  - 获取存在的产品
  - 获取不存在的产品

- **创建产品（商家）**
  - 商家成功创建产品
  - 普通用户访问受限功能

### 4.3 集成测试执行

运行集成测试：

```bash
# 运行所有集成测试
npx jest __tests__/integration/

# 运行特定集成测试
npx jest __tests__/integration/userRoutes.test.js
```

## 5. 系统测试

### 5.1 测试范围

系统测试覆盖完整的业务流程，包括：

- 用户注册到下单的完整购物流程
- 管理员管理功能
- 商家管理商品功能

### 5.2 测试示例

#### 5.2.1 购物流程系统测试

完整购物流程包括：

1. 买家注册
2. 买家登录
3. 商家注册
4. 商家创建商品
5. 管理员批准商品上架
6. 买家添加商品到购物车
7. 买家查看购物车
8. 买家下单
9. 买家查看订单

#### 5.2.2 管理员功能系统测试

- 管理员登录
- 获取所有用户
- 获取系统统计信息

### 5.3 系统测试执行

运行系统测试：

```bash
# 运行所有系统测试
npx jest __tests__/system/

# 运行特定系统测试
npx jest __tests__/system/userFlow.test.js
```

## 6. 测试覆盖率

### 6.1 覆盖率目标

- 单元测试覆盖率：≥80%
- 关键业务逻辑覆盖率：100%

### 6.2 生成覆盖率报告

```bash
npm run test:coverage
```

覆盖率报告将生成在 `coverage/` 目录下。

## 7. 测试数据管理

### 7.1 测试数据策略

- 使用模拟数据（Mock Data）避免对生产数据库的影响
- 每个测试后清理测试数据，确保测试独立性
- 使用独立的测试数据库（如果需要）

### 7.2 数据库模拟

- 使用 Jest 的模拟功能模拟数据库查询
- 每个测试前重置模拟状态

## 8. 测试执行流程

### 8.1 持续集成流程

1. 代码提交后自动触发测试
2. 运行单元测试
3. 运行集成测试
4. 生成覆盖率报告
5. 测试通过后合并代码

### 8.2 本地测试流程

1. 确保依赖已安装：`npm install`
2. 运行所有测试：`npm test`
3. 检查覆盖率报告
4. 修复失败的测试

## 9. 常见问题和解决方案

### 9.1 测试失败

- 检查模拟数据是否正确
- 确认API端点和参数是否正确
- 验证中间件配置

### 9.2 数据库连接问题

- 确保测试环境使用模拟数据库
- 检查环境变量配置

### 9.3 JWT令牌问题

- 确保在测试中使用正确的密钥
- 模拟令牌验证过程

## 10. 测试维护

### 10.1 测试更新

- 每次功能更新后更新相应测试
- 定期审查和重构测试代码
- 确保测试与实际实现保持同步

### 10.2 测试优化

- 优化测试执行时间
- 提高测试覆盖率
- 增加边界条件测试

## 11. 附录

### 11.1 测试文件结构

```
__tests__/
├── setup.js              # 测试设置
├── userController.test.js # 用户控制器单元测试
├── db.test.js            # 数据库配置单元测试
├── authMiddleware.test.js # 认证中间件单元测试
├── integration/          # 集成测试
│   ├── userRoutes.test.js
│   └── productRoutes.test.js
└── system/              # 系统测试
    └── userFlow.test.js
```

### 11.2 测试命令参考

```bash
# 运行所有测试
npm test

# 运行测试并监听变化
npm run test:watch

# 运行测试并生成覆盖率报告
npm run test:coverage

# 运行特定测试文件
npx jest __tests__/userController.test.js

# 运行集成测试
npx jest __tests__/integration/

# 运行系统测试
npx jest __tests__/system/
```